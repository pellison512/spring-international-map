

<div id="anychart-embed-samples-maps-marker-02" class="anychart-embed anychart-embed-samples-maps-marker-02">
    <button id="zoomOut" style="display:none;"> Zoom Out </button>
    <div id="content" class="panel-wrap">
        <button id="closePanel" style="display:block;" class="button"> Close </button>
        <div id= "truster" class="panel">
        </div>
        </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.4.1/js/anychart-base.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.4.1/js/anychart-core.min.js" type="text/javascript"></script>
<script src="https://cdn.anychart.com/releases/8.4.1/js/anychart-map.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.4.1/js/anychart-exports.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.4.1/themes/light_provence.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.4.1/js/anychart-ui.min.js"></script>
<script src="https://cdn.anychart.com/geodata/1.2.0/custom/world/world.js"></script>
<script src="https://cdn.anychart.com/geodata/1.2.0/countries/united_states_of_america/united_states_of_america.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.15/proj4.js"></script>
<script src="https://cdn.anychart.com/releases/8.4.1/js/anychart-data-adapter.min.js"></script>

<div id="ac_style_samples-maps-marker-02" style="display:none;">
<style>
  html, body, #container {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
  }
</style>
</div>




<script>(function(){
function ac_add_to_head(el){
	var head = document.getElementsByTagName('head')[0];
	head.insertBefore(el,head.firstChild);
}
function ac_add_link(url){
	var el = document.createElement('link');
	el.rel='stylesheet';el.type='text/css';el.media='all';el.href=url;
	ac_add_to_head(el);
}
function ac_add_style(css){
	var ac_style = document.createElement('style');
	if (ac_style.styleSheet) ac_style.styleSheet.cssText = css;
	else ac_style.appendChild(document.createTextNode(css));
	ac_add_to_head(ac_style);
}
ac_add_link('https://cdn.anychart.com/releases/8.2.0/css/anychart-ui.min.css');
ac_add_style(document.getElementById("ac_style_samples-maps-marker-02").innerHTML);
ac_add_style(".anychart-embed-samples-maps-marker-02{width:100%;height:100%;}");
ac_add_link("panel.css")
ac_add_style(document.getElementById("content").innerHTML);

})();
</script>

<div id="container"></div>
<script>
  anychart.onDocumentReady(function () {

    anychart.theme('lightProvence');
    // This sample uses 3rd party proj4 component
    // that makes it possible to set coordinates
    // for the points and labels on the map and
    // required for custom projections and grid labels formatting.
    // See https://docs.anychart.com/Maps/Map_Projections

    // Different Maps
    var json1 = "https://api.myjson.com/bins/c8se0";
    var json2 = "https://api.myjson.com/bins/rjmmw";
    var json3 = "https://api.myjson.com/bins/9swt4";
    var json4 = "https://api.myjson.com/bins/127yfs";
    var json5 = "https://api.myjson.com/bins/wv1zs";
    var json6 = "https://api.myjson.com/bins/e86rc"; // about 2,000 points in same location

    // AJAX GET Request
    var xhReq = new XMLHttpRequest();
    xhReq.open("GET", json4, false);
    xhReq.send(null);
    var jsonObject = JSON.parse(xhReq.responseText);

    var clientName = jsonObject.data.clientName;
    var buckets = jsonObject.data.buckets;
    var dataPoints = jsonObject.data.dataPoints;

    var DataSet = anychart.data.set(dataPoints).mapAs();
    var map = anychart.map();
   // map.interactivity().selectionMode('singleSelect');
  var dataSetWorld = [
      {'id': 'US', 'value':5, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/countries/united_states_of_america/united_states_of_america.json'}
    ];

var dataSetUS = [
    {'id': 'US.TX', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/texas/texas.json'},

    {'id': 'US.AL', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/alabama/alabama.json'},
    {'id': 'US.AR', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/arkansas/arkansas.json'},
    {'id': 'US.AZ', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/arizona/arizona.json'},
    {'id': 'US.AK', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/alaska/alaska.json'},
    {'id': 'US.CA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/california/california.json'},
    {'id': 'US.CO', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/colorado/colorado.json'},
    {'id': 'US.CT', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/connecticut/connecticut.json'},
    {'id': 'US.DE', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/delaware/delaware.json'},
    {'id': 'US.FL', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/florida/florida.json'},
    {'id': 'US.GA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/georgia/georgia.json'},
    {'id': 'US.HI', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/hawaii/hawaii.json'},
    {'id': 'US.ID', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/idaho/idaho.json'},
    {'id': 'US.IL', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/illinois/illinois.json'},
    {'id': 'US.IN', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/indiana/indiana.json'},
    {'id': 'US.IA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/iowa/iowa.json'},
    {'id': 'US.KS', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/kansas/kansas.json'},
    {'id': 'US.KY', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/kentucky/kentucky.json'},
    {'id': 'US.LA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/louisiana/louisiana.json'},
    {'id': 'US.ME', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/maine/maine.json'},
    {'id': 'US.MD', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/maryland/maryland.json'},
    {'id': 'US.MA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/massachusetts/massachusetts.json'},
    {'id': 'US.MO', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/missouri/missouri.json'},
    {'id': 'US.MN', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/minnesota/minnesota.json'},
    {'id': 'US.MS', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/mississippi/mississippi.json'},
    {'id': 'US.MI', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/michigan/michigan.json'},
    {'id': 'US.MT', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/montana/montana.json'},
    {'id': 'US.NV', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/nevada/nevada.json'},
    {'id': 'US.NE', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/nebraska/nebraska.json'},
    {'id': 'US.NH', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/new_hampshire/new_hampshire.json'},
    {'id': 'US.NJ', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/new_jersey/new_jersey.json'},
    {'id': 'US.NM', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/new_mexico/new_mexico.json'},
    {'id': 'US.NY', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/new_york/new_york.json'},
    {'id': 'US.NC', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/north_carolina/north_carolina.json'},
    {'id': 'US.ND', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/north_dakota/north_dakota.json'},
    {'id': 'US.OH', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/ohio/ohio.json'},
    {'id': 'US.OK', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/oklahoma/oklahoma.json'},
    {'id': 'US.OR', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/oregon/oregon.json'},
    {'id': 'US.PA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/pennsylvania/pennsylvania.json'},
    {'id': 'US.RI', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/rhode_island/rhode_island.json'},
    {'id': 'US.SC', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/south_carolina/south_carolina.json'},
    {'id': 'US.SD', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/south_dakota/south_dakota.json'},
    {'id': 'US.TN', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/tennessee/tennessee.json'},
    {'id': 'US.UT', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/utah/utah.json'},
    {'id': 'US.VT', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/vermont/vermont.json'},
    {'id': 'US.VA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/virginia/virginia.json'},
    {'id': 'US.WA', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/washington/washington.json'},
    {'id': 'US.WV', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/west_virginia/west_virginia.json'},
    {'id': 'US.WI', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/wisconsin/wisconsin.json'},
    {'id': 'US.WY', 'value': 26956958, 'url':'https://cdn.anychart.com/releases/8.4.0/geodata/usa_states/wyoming/wyoming.json'}
];

var dataSetTX1 = [
    {'id': 'US.TX.111', 'value': 6222},
    {'id': 'US.TX.421', 'value': 3186},
    {'id': 'US.TX.195', 'value': 5369},
    {'id': 'US.TX.357', 'value': 9006},
    {'id': 'US.TX.295', 'value': 3057}
];
var dataSetTX=[];

var dataSets = {
  'US': dataSetUS,
  'US.TX': dataSetTX,
}


map.geoData(anychart.maps.world);

worldSeries = map.choropleth(dataSetWorld);

worldSeries.listen('pointClick', function(e){

  loadMap(e.point.get('id'), e.point.get('url'), map);
});

worldSeries.legendItem(false);

document.getElementById('zoomOut').style.display= "none";

function loadMap(id, url, map){
  anychart.data.loadJsonFile(url, function(data){
      var drillMap = anychart.map();
      drillMap.geoData(data);

      drillMap.title()
          .enabled(true)
          .useHtml(true)
          .padding([20, 0, 10, 0])
          .text('Spring International<br/>' +
            '<span style="color:#929292; font-size: 12px;">' +
            clientName + '</span>');


      var drillSeries = drillMap.choropleth(dataSets[id]);

      drillSeries.legendItem(false);
      //secondSeries = drillMap.marker(DataSet);

      for(var i=0; i<buckets.length; i++){
        var bucket = buckets[i];

        var data = DataSet.filter('vulnerability', filter_function(bucket.from, bucket.to));
        var color = bucket.color;
        var secondSeries = drillMap.marker(data);
        secondSeries.name(bucket.name)
          .fill(color)
          .stroke('2 #E1E1E1')
          .type('circle')
          .size(5)
          .labels(false)
          .selectionMode('none');

          secondSeries.hovered()
       .stroke('2 #fff')
       .size(10);

      secondSeries.legendItem()
       .iconType('circle')
       .iconFill(color)
       .iconStroke('2 #E1E1E1');

secondSeries.listen('pointClick', function(e){

showLocationInfo(1,1);
});
      var background = secondSeries.tooltip().background();
      background.fill(anychart.color.lighten(color, 0.7));
      }
var elem = document.getElementById('zoomOut');
if(typeof elem != 'undefined' && elem != null) {
document.getElementById('zoomOut').style.display= "";

document.getElementById('zoomOut').onclick = function(e){
  drillMap.drillUp();
  if(pathToString(drillMap.getDrilldownPath()) == "World"){
  document.getElementById('zoomOut').style.display = "none";
  }
}
}

      drillSeries.listen('pointClick', function(e){
        console.log('here in pointclick listener');
        loadMap(e.point.get('id'), e.point.get('url'), map);
      });


      map.drillTo(id, drillMap);
    });
}





    map.title()
          .enabled(true)
          .useHtml(true)
          .padding([20, 0, 10, 0])
          .text('Spring International<br/>' +
            '<span style="color:#929292; font-size: 12px;">' +
            clientName + '</span>');
    // Creates the marker series
    //var series_lat_long = map.marker(data);
    var createSeries = function(name, data, color) {
     // sets marker series and series settings
      var series = map.marker(data);
      series.name(name)
       .fill(color)
       .stroke('2 #E1E1E1')
       .type('circle')
       .size(5)
       .labels(false)
       .selectionMode('none');

      series.hovered()
       .stroke('2 #fff')
       .size(10);

      series.legendItem()
       .iconType('circle')
       .iconFill(color)
       .iconStroke('2 #E1E1E1');

      var background = series.tooltip().background();
      background.fill(anychart.color.lighten(color, 0.7));
      //background.stroke('#888');
      //background.cornerType('roundInner');
      //background.coners(5);
      //series.tooltip.hideDelay(1000);
      series.listen('pointClick', function(e){

       showLocationInfo(1,1);
});

    };

   for (var i=0; i<buckets.length; i++) {
     var bucket = buckets[i];
     createSeries(bucket.name, DataSet.filter('vulnerability', filter_function(bucket.from, bucket.to)), bucket.color);
   }


   map.tooltip().title().fontColor('#fff');

   map.tooltip().titleFormat(function() {
     return this.getData('date')
   });

    // format the tooltips of the lat_long series
  //  series_lat_long.tooltip().titleFormat("{%name}");
    //series_lat_long.tooltip().format("Vulnerability: {%vulnerability}");
    map.tooltip()
    .useHtml(true)
    .padding([8, 13, 10, 13])
    .width(350)
    .fontSize(12)
    .fontColor('#000000')
    .format(function() {

    return '<span style="font-size: 13px"><span style="color: #000000">Vulnerability: ' + '</span>' + this.getData('vulnerability') + '%<br/>' +
    '<span style="color: #000000">Place: ' + '</span>' + this.getData('name') + '<br/>' +
    '<span style="color: #000000">Count: ' + '</span>' + this.getData('count') + '</span>';
    });
  //  map.title("Marker series defined by latitude and longitude");
    map.legend(true);
    var zoomController = anychart.ui.zoom();
    zoomController.render(map);
    map.container("container");
    map.draw();


    /* Finding starting zoom level */
    var xAvg = 0;
    var yAvg = 0;
    for(var i = 0; i < dataPoints.length; i++) {
      var coords = map.transform(dataPoints[i].long, dataPoints[i].lat);
      xAvg += coords.x;
      yAvg += coords.y;
    }
    xAvg = xAvg / dataPoints.length;
    yAvg = yAvg / dataPoints.length;
    console.log("xAvg: " + xAvg);
    console.log("yAvg: " + yAvg);

    var xStdDev = 0;
    var yStdDev = 0;
    for (var i=0; i < dataPoints.length; i++) {
      var coords = map.transform(dataPoints[i].long, dataPoints[i].lat);
      xStdDev += Math.pow(coords.x - xAvg, 2);
      yStdDev += Math.pow(coords.y - yAvg, 2);
    }
    xStdDev = Math.sqrt(xStdDev / dataPoints.length);
    yStdDev = Math.sqrt(yStdDev / dataPoints.length);
    console.log("xStdDev: " + xStdDev);
    console.log("yStdDev: " + yStdDev);
    var avgStdDev = (xStdDev + yStdDev) / 2;
    console.log("avgStdDev: " + avgStdDev);

    var zoomLevel = -(Math.log(avgStdDev/3) / Math.log(1.4)) + 11;
    console.log("zoomLevel: " + zoomLevel);

    map.zoom(zoomLevel, xAvg, yAvg);


    var clicked = true;
    map.listen("dblclick", function(evt) {
        if (clicked) {
            map.zoomTo(3, evt.clientX, evt.clientY);
        }
        else {
            map.zoomTo(0, evt.clientX, evt.clientY);
        }
        document.getElementById("content").style.transform = "translatex(100%)"
    clicked = !clicked;
  });
  map.interactivity().zoomOnMouseWheel(true);

console.log(map.getDrilldownPath());


var showLocationInfo = function(index, series_index) {
  console.log("fuck");
    document.getElementById("truster").innerHTML ='<object type="text/html" data="http://example.com/"style="width:100%;height:90%" ></object>';
    document.getElementById("content").style.transform = "translatex(0%)"

}
});


function filter_function(val1, val2) {
  if (val2)
    return function(fieldVal) {
      return val1 <= fieldVal && fieldVal < val2;
    };
  else
    return function(fieldVal) {
      return val1 <= fieldVal;
    };
}

function pathToString(path) {
    var text = 'World';
    for (i = 1; i < path.length - 1; i++) {
        text += '/' + path[i].getId();
    }
    return text;
}

</script>
</div>
